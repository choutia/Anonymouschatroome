<!--
Anonymous Chat - Single-file website (index.html)
Features:
- Anonymous sign-in (Firebase Anonymous Auth)
- Create or join a chat room via URL query parameter ?room=ROOMID
- Real-time messages using Firebase Realtime Database
- Deployable to GitHub Pages (static single file)

Setup steps (short):
1. Go to https://console.firebase.google.com and create a new project.
2. In Project Settings -> General, add a Web App and copy the firebaseConfig object.
3. In Authentication -> Sign-in method, enable "Anonymous" sign-in.
4. In Realtime Database, create a database and set rules (example below).
5. Replace the placeholder firebaseConfig in this file with your own config.
6. Commit this file as index.html into a GitHub repo and enable GitHub Pages (branch: main or gh-pages).

Example Realtime Database rules (development):
{
  "rules": {
    "rooms": {
      "$roomId": {
        ".read": true,
        ".write": true
n      }
    }
  }
}

For production, tighten rules (e.g., limit message size, rate limit, auth checks).
--><!doctype html>

<html lang="ur">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Anonymous Chat (Deploy to GitHub Pages)</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--text:#e6eef8}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Arial}
    body{background:linear-gradient(180deg,#071029 0%, #0b1220 100%);color:var(--text);display:flex;align-items:center;justify-content:center;padding:20px}
    .app{width:100%;max-width:820px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:12px;padding:16px;box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    h1{font-size:18px;margin:0}
    .muted{color:var(--muted);font-size:13px}
    .top{display:flex;gap:10px;align-items:center}
    .room-link{background:#031024;padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);cursor:pointer}
    main{display:grid;grid-template-columns:1fr 320px;gap:12px}
    .chat{background:var(--card);padding:12px;border-radius:10px;min-height:420px;display:flex;flex-direction:column}
    .messages{flex:1;overflow:auto;padding-right:6px}
    .msg{margin:8px 0;max-width:78%;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,0.03);font-size:14px}
    .msg.you{background:linear-gradient(90deg, rgba(6,182,212,0.12), rgba(6,182,212,0.06));margin-left:auto}
    .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    form{display:flex;gap:8px;padding-top:8px}
    input[type=text]{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--text)}
    button{background:var(--accent);color:#001;border:none;padding:10px 12px;border-radius:8px;cursor:pointer}
    aside{background:linear-gradient(0deg, rgba(255,255,255,0.02), transparent);padding:12px;border-radius:10px}
    label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted)}
    .small{font-size:13px;color:var(--muted);margin-top:8px}
    .danger{color:#ffb4b4}
    .room-id{font-family:monospace;background:rgba(255,255,255,0.02);padding:6px;border-radius:6px;display:inline-block}
    footer{margin-top:10px;text-align:center;font-size:13px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <div>
        <h1>Anonymous Chat</h1>
        <div class="muted">Shareable room link — کوئی sign up نہیں چاہیے</div>
      </div>
      <div class="top">
        <div id="status" class="muted">Connecting...</div>
        <div class="room-link" id="copyBtn" title="Copy room link">Copy link</div>
      </div>
    </header><main>
  <section class="chat" aria-label="Chat window">
    <div class="meta">Room: <span id="roomIdDisplay" class="room-id">—</span></div>
    <div class="messages" id="messages" ></div>
    <form id="sendForm">
      <input id="txt" type="text" placeholder="Type message..." maxlength="400" autocomplete="off" />
      <button type="submit">Send</button>
    </form>
  </section>

  <aside>
    <label>Your name (optional)</label>
    <input id="displayName" type="text" placeholder="e.g., Mehman" maxlength="30" />
    <div class="small">Room link will keep you in this room. You can create a new room by clicking "New Room"</div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button id="newRoomBtn" type="button">New Room</button>
      <button id="leaveBtn" type="button">Leave</button>
    </div>
    <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)" />
    <div class="muted">Tips</div>
    <ul class="small" style="padding-left:18px">
      <li>Be kind — کوئی moderation نہیں ہے.</li>
      <li>For public rooms, anyone with the link can join.</li>
    </ul>
  </aside>
</main>

<footer>Built for personal use — Deploy on GitHub Pages</footer>

  </div>  <!-- Firebase SDKs (v9) from CDN -->  <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBJacURrsQLyyckekstnSZ0Hpv-d4pPjNc",
    authDomain: "anonymouschat-room.firebaseapp.com",
    projectId: "anonymouschat-room",
    storageBucket: "anonymouschat-room.firebasestorage.app",
    messagingSenderId: "856289031044",
    appId: "1:856289031044:web:7c0bed5e8f5f434b6063d1",
    measurementId: "G-K09GSM4L9X"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
</script>

    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js'
    import { getDatabase, ref, push, onChildAdded, serverTimestamp, limitToLast, query } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js'
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js'

    const app = initializeApp(firebaseConfig)
    const db = getDatabase(app)
    const auth = getAuth(app)

    // UI elements
    const statusEl = document.getElementById('status')
    const messagesEl = document.getElementById('messages')
    const sendForm = document.getElementById('sendForm')
    const txt = document.getElementById('txt')
    const roomIdDisplay = document.getElementById('roomIdDisplay')
    const copyBtn = document.getElementById('copyBtn')
    const newRoomBtn = document.getElementById('newRoomBtn')
    const leaveBtn = document.getElementById('leaveBtn')
    const displayNameInput = document.getElementById('displayName')

    // Helpers
    function uidShort() { return Math.random().toString(36).slice(2,9) }
    function getRoomFromUrl(){
      const params = new URLSearchParams(window.location.search)
      return params.get('room') || null
    }
    function setRoomInUrl(room){
      const u = new URL(window.location.href)
      u.searchParams.set('room', room)
      history.replaceState(null,'',u.toString())
    }

    let roomId = getRoomFromUrl()
    if(!roomId){ roomId = uidShort(); setRoomInUrl(roomId) }
    roomIdDisplay.textContent = roomId

    copyBtn.addEventListener('click', async()=>{
      try{
        await navigator.clipboard.writeText(window.location.href)
        copyBtn.textContent = 'Copied!'
        setTimeout(()=>copyBtn.textContent = 'Copy link',1200)
      }catch(e){
        alert('Copy failed — please copy manually')
      }
    })

    newRoomBtn.addEventListener('click', ()=>{
      const newRoom = uidShort()
      setRoomInUrl(newRoom)
      roomId = newRoom
      roomIdDisplay.textContent = roomId
      // reload listeners
      initMessageListener()
    })

    leaveBtn.addEventListener('click', ()=>{
      window.location.href = window.location.origin + window.location.pathname
    })

    // Authentication
    statusEl.textContent = 'Signing in anonymously...'
    signInAnonymously(auth).catch(err=>{
      console.error(err); statusEl.textContent = 'Auth error'
    })

    onAuthStateChanged(auth, user =>{
      if(user){
        statusEl.textContent = 'Connected (anon)'
        initMessageListener()
      }
    })

    // Message handling
    let messagesRef
    let childAddedUnsub
    function initMessageListener(){
      // clear old messages
      messagesEl.innerHTML = ''
      messagesRef = ref(db, `rooms/${roomId}/messages`)
      const q = query(messagesRef, limitToLast(200))
      onChildAdded(q, snap=>{
        const data = snap.val()
        if(!data) return
        const isYou = (data.uid && auth.currentUser && data.uid === auth.currentUser.uid)
        addMessageToDOM(data, isYou)
      })
    }

    function addMessageToDOM(data, isYou){
      const wrap = document.createElement('div')
      wrap.className = 'msg' + (isYou? ' you':'')
      const who = data.name? `${escapeHtml(data.name)}:` : ''
      const time = new Date(data.ts || Date.now()).toLocaleTimeString()
      wrap.innerHTML = `<div style="font-size:12px;color:var(--muted);margin-bottom:6px">${who} <span style=\"font-family:monospace;color:var(--muted)\">${time}</span></div><div>${escapeHtml(data.text)}</div>`
      messagesEl.appendChild(wrap)
      messagesEl.scrollTop = messagesEl.scrollHeight
    }

    function escapeHtml(unsafe){
      if(!unsafe && unsafe !== 0) return ''
      return String(unsafe)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;")
    }

    sendForm.addEventListener('submit', async (e)=>{
      e.preventDefault()
      const text = txt.value.trim()
      if(!text) return
      if(text.length > 400) return alert('Message too long')
      const name = (displayNameInput.value || '').trim().slice(0,30)
      const payload = {
        text: text,
        name: name || null,
        uid: auth.currentUser? auth.currentUser.uid : null,
        ts: Date.now()
      }
      try{
        await push(ref(db, `rooms/${roomId}/messages`), payload)
        txt.value = ''
      }catch(err){
        console.error(err); alert('Send failed')
      }
    })

  </script></body>
</html>
